<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Relacionamentos - Sistema M√©dicos SaaS</title>
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .legend-item {
            padding: 10px;
            border-left: 4px solid;
            background: white;
            border-radius: 4px;
        }
        .saas { border-color: #3498db; }
        .business { border-color: #27ae60; }
        .financial { border-color: #f39c12; }
        .tax { border-color: #e74c3c; }
        .expenses { border-color: #9b59b6; }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .legend-desc {
            font-size: 0.9em;
            color: #666;
        }
        .diagram-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #3498db;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Sistema M√©dicos SaaS - Diagrama de Relacionamentos</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">22</div>
                <div class="stat-label">Modelos de Dados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">45+</div>
                <div class="stat-label">Relacionamentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">100%</div>
                <div class="stat-label">Multi-tenant</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">5</div>
                <div class="stat-label">√Åreas de Neg√≥cio</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item saas">
                <div class="legend-title">üîê SaaS Core</div>
                <div class="legend-desc">Usu√°rios, Contas, Licen√ßas e Memberships</div>
            </div>
            <div class="legend-item business">
                <div class="legend-title">üë• Entidades de Neg√≥cio</div>
                <div class="legend-desc">Pessoas, Empresas e S√≥cios</div>
            </div>
            <div class="legend-item expenses">
                <div class="legend-title">üí∞ Gest√£o de Despesas</div>
                <div class="legend-desc">Grupos, Itens e Rateios de Despesas</div>
            </div>
            <div class="legend-item tax">
                <div class="legend-title">üèõÔ∏è Gest√£o Fiscal</div>
                <div class="legend-desc">Notas Fiscais, Apura√ß√µes e Impostos</div>
            </div>
            <div class="legend-item financial">
                <div class="legend-title">üí≥ Movimenta√ß√£o Financeira</div>
                <div class="legend-desc">Fluxo de Caixa e Aplica√ß√µes</div>
            </div>
        </div>

        <div class="diagram-container">
            <div class="mermaid">
erDiagram
    %% Modelos Core SaaS
    CustomUser {
        int id PK
        string email UK "Login principal"
        string username
        string first_name
        string last_name
        boolean is_active
        datetime date_joined
    }

    Conta {
        int id PK
        string name UK "Nome da conta/tenant"
        string cnpj "CNPJ da empresa"
        datetime created_at
    }

    Licenca {
        int id PK
        int conta_id FK
        string plano "Tipo do plano"
        date data_inicio
        date data_fim
        boolean ativa
        int limite_usuarios "M√°x usu√°rios"
    }

    ContaMembership {
        int id PK
        int user_id FK
        int conta_id FK
        string role "admin/member"
        datetime date_joined
        int invited_by_id FK
    }

    %% Entidades de Neg√≥cio
    Pessoa {
        int id PK
        int conta_id FK
        string CPF UK "√önico por conta"
        string name "Nome completo"
        string profissao
        date dnascimento
        string address1
        string city
        string phone1
        string email
        datetime created_at
        datetime updated_at
    }

    Empresa {
        int id PK
        int conta_id FK
        string CNPJ UK "√önico por conta"
        string name "Raz√£o social"
        int status
        int tipo_regime "Compet√™ncia/Caixa"
    }

    Socio {
        int id PK
        int conta_id FK
        int empresa_id FK
        int pessoa_id FK
    }

    %% Configura√ß√µes
    Alicotas {
        int id PK
        int conta_id FK
        decimal ISS "Al√≠quota ISS"
        decimal PIS "Al√≠quota PIS"
        decimal COFINS "Al√≠quota COFINS"
        decimal IRPJ_ALIC_1 "IRPJ Normal"
        decimal IRPJ_ALIC_2 "IRPJ Adicional"
        decimal CSLL_ALIC_1 "CSLL Normal"
    }

    %% Despesas
    Despesa_Grupo {
        int id PK
        int conta_id FK
        string codigo UK "GERAL/FOLHA/SOCIO"
        string descricao
        int tipo_rateio
    }

    Despesa_Item {
        int id PK
        int conta_id FK
        int grupo_id FK
        string codigo UK "C√≥digo do item"
        string descricao
    }

    Despesa {
        int id PK
        int conta_id FK
        int item_id FK
        int empresa_id FK
        int socio_id FK "Opcional"
        date data
        decimal valor
        string descricao
    }

    %% Documentos Fiscais
    NotaFiscal {
        int id PK
        int conta_id FK
        string numero "N¬∫ da NF"
        string tomador "Cliente"
        int fornecedor_id FK
        int socio_id FK
        date dtEmissao
        date dtRecebimento
        decimal val_bruto
        decimal val_liquido
        decimal val_ISS
        decimal val_PIS
        decimal val_COFINS
        int tipo_aliquota "Consultas/Plant√£o/Outros"
    }

    %% Financeiro
    Financeiro {
        int id PK
        int conta_id FK
        date data
        int fornecedor_id FK
        int socio_id FK
        int notafiscal_id FK "Opcional"
        int tipo "Cr√©dito/D√©bito"
        int descricao_id FK
        decimal valor
        boolean operacao_auto "Autom√°tica?"
    }

    Desc_movimentacao_financeiro {
        int id PK
        int conta_id FK
        string descricao "Descri√ß√£o padr√£o"
    }

    %% Relacionamentos SaaS Core
    Conta ||--|| Licenca : "possui √∫nica"
    CustomUser ||--o{ ContaMembership : "membro de v√°rias"
    Conta ||--o{ ContaMembership : "tem v√°rios membros"
    CustomUser ||--o{ ContaMembership : "convidou outros"

    %% Multi-tenancy (Todos relacionados √† Conta)
    Conta ||--o{ Pessoa : "possui pessoas"
    Conta ||--o{ Empresa : "possui empresas"
    Conta ||--o{ Socio : "possui s√≥cios"
    Conta ||--o{ Alicotas : "possui configura√ß√£o"
    Conta ||--o{ Despesa_Grupo : "possui grupos"
    Conta ||--o{ Despesa_Item : "possui itens"
    Conta ||--o{ Despesa : "possui despesas"
    Conta ||--o{ NotaFiscal : "possui notas"
    Conta ||--o{ Financeiro : "possui movimenta√ß√µes"
    Conta ||--o{ Desc_movimentacao_financeiro : "possui descri√ß√µes"

    %% Relacionamentos de Neg√≥cio
    Empresa ||--o{ Socio : "tem s√≥cios"
    Pessoa ||--o{ Socio : "√© s√≥cio de empresas"
    
    Despesa_Grupo ||--o{ Despesa_Item : "cont√©m itens"
    Despesa_Item ||--o{ Despesa : "gera despesas"
    Empresa ||--o{ Despesa : "fornecedor da despesa"
    Socio ||--o{ Despesa : "relacionado √† despesa"
    
    Empresa ||--o{ NotaFiscal : "fornecedor da NF"
    Socio ||--o{ NotaFiscal : "emitida pelo s√≥cio"
    
    Empresa ||--o{ Financeiro : "fornecedor da movimenta√ß√£o"
    Socio ||--o{ Financeiro : "s√≥cio da movimenta√ß√£o"
    NotaFiscal ||--o{ Financeiro : "origem da movimenta√ß√£o"
    Desc_movimentacao_financeiro ||--o{ Financeiro : "descri√ß√£o da movimenta√ß√£o"
            </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px;">
            <h3>üéØ Principais Caracter√≠sticas do Design</h3>
            <ul>
                <li><strong>Multi-tenancy:</strong> Todos os dados isolados por Conta (tenant)</li>
                <li><strong>Seguran√ßa:</strong> Constraints unique_together garantem unicidade por tenant</li>
                <li><strong>Escalabilidade:</strong> Arquitetura SaaS preparada para m√∫ltiplos clientes</li>
                <li><strong>Flexibilidade:</strong> Configura√ß√µes espec√≠ficas por conta (Al√≠cotas, Grupos, etc.)</li>
                <li><strong>Auditoria:</strong> Campos de created_at/updated_at para rastreamento</li>
                <li><strong>Integridade:</strong> Relacionamentos bem definidos com CASCADE apropriado</li>
                <li><strong>Dom√≠nio Completo:</strong> Cobertura de todas as necessidades do neg√≥cio m√©dico/cont√°bil</li>
            </ul>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; text-align: center; color: #666;">
            <small>Diagrama gerado automaticamente baseado nos modelos Django do sistema</small>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#34495e',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#bdc3c7'
            }
        });
    </script>
</body>
</html>
