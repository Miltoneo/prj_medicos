{% extends 'layouts/base_cenario_despesas.html' %}
{% load django_tables2 %}
{% block content %}
<div class="container-fluid px-0">
  <div class="row justify-content-center">
    <div class="col-12 col-md-12 col-lg-12 col-xl-11" style="max-width: 1600px;">
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
          <div class="mb-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <h4 class="fw-bold text-primary mb-0">Despesas Apropriadas dos Sócios</h4>
            <div class="d-flex gap-3 flex-wrap">
              <div class="fw-semibold bg-light rounded-2 px-3 py-2 mb-0">Total de despesas: <span class="text-primary">{{ table.rows|length }}</span></div>
              <div class="fw-bold bg-light rounded-2 px-3 py-2 mb-0">Total geral: <span class="text-success">R$ {{ total_despesas|floatformat:2 }}</span></div>
            </div>
          </div>
          <form method="get" class="bg-light rounded-3 p-3 mb-4 shadow-sm">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-4 col-lg-3">
                <label for="competencia" class="form-label mb-1">Competência:</label>
                <input type="month" id="competencia" name="competencia" class="form-control form-control-sm" value="{{ competencia }}">
              </div>
              <div class="col-12 col-md-4 col-lg-3">
                <label for="socio" class="form-label mb-1">Sócio:</label>
                <select id="socio" name="socio" class="form-select form-select-sm">
                  {% for id, nome in socios %}
                    <option value="{{ id }}" {% if forloop.first and not socio_id %}selected{% elif socio_id|stringformat:'s' == id|stringformat:'s' %}selected{% endif %}>{{ nome }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-12 col-lg-6">
                <div class="d-flex gap-2 align-items-end flex-nowrap">
                  <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-1"></i>Filtrar</button>
                  <a href="{% url 'medicos:despesas_socio_form' empresa_id=request.resolver_match.kwargs.empresa_id %}?socio={{ socio_id }}{% if competencia %}&competencia={{ competencia }}{% endif %}" class="btn btn-success"><i class="fas fa-plus me-1"></i>Nova Despesa</a>
                  <a href="#" class="btn btn-outline-secondary disabled"><i class="fas fa-copy me-1"></i>Copiar do mês anterior</a>
                </div>
              </div>
            </div>
          </form>
          <div class="table-responsive rounded-3 border bg-white shadow-sm">
            {% if table.rows %}
              {% render_table table %}
              <script>
                // Move a coluna Data para a primeira posição na tabela renderizada
                document.addEventListener('DOMContentLoaded', function() {
                  const table = document.querySelector('.table-responsive table');
                  if (table) {
                    // Move o th
                    const ths = table.querySelectorAll('thead tr th');
                    const dataTh = Array.from(ths).find(th => th.textContent.trim().toLowerCase().includes('data'));
                    if (dataTh && ths[0] !== dataTh) {
                      dataTh.parentNode.insertBefore(dataTh, ths[0]);
                    }
                    // Move os tds
                    table.querySelectorAll('tbody tr').forEach(tr => {
                      const tds = tr.querySelectorAll('td');
                      const dataTd = Array.from(tds).find((td, idx) => ths[idx].textContent.trim().toLowerCase().includes('data'));
                      if (dataTd && tds[0] !== dataTd) {
                        dataTd.parentNode.insertBefore(dataTd, tds[0]);
                      }
                    });
                  }
                });
              </script>
            {% else %}
              <div class="text-center text-muted py-4">Nenhuma despesa apropriada encontrada para o mês selecionado.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
