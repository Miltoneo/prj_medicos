{% extends "layouts/base_cenario_apuracao.html" %}
{% block title %}Relatório Mensal do Sócio{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-submit do formulário de filtro quando campos forem alterados
  const formFields = document.querySelectorAll('#id_socio, #id_mes_ano');
  formFields.forEach(function(field) {
    if (field) {
      field.addEventListener('change', function() {
        // Submete o formulário automaticamente quando um campo é alterado
        this.closest('form').submit();
      });
    }
  });
  
  // Se a página foi carregada sem parâmetros de filtro, garantir que o mês atual esteja selecionado
  const mesAnoField = document.getElementById('id_mes_ano');
  if (mesAnoField) {
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilterParams = urlParams.has('mes_ano') || urlParams.has('socio_id');
    
    if (!hasFilterParams && !mesAnoField.value) {
      // Define o mês atual se não há valor
      const today = new Date();
      const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      mesAnoField.value = currentMonth;
      
      // Submete automaticamente para aplicar o filtro do mês atual
      setTimeout(() => {
        mesAnoField.closest('form').submit();
      }, 100);
    }
  }
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4 w-100" style="max-width:none;">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="fas fa-user-friends me-2"></i>
          <span class="fw-bold">Relatório Mensal do Sócio</span>
        </div>
        <div class="card-body">
          {% if empresa %}
            <div class="mb-3">
              <span class="fw-bold">Empresa:</span> {{ empresa.nome_fantasia|default:empresa.name }}
            </div>
          {% else %}
            <div class="mb-3">
              <span class="fw-bold text-danger">Empresa não selecionada</span>
            </div>
          {% endif %}
          <form method="get" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label for="id_mes_ano" class="form-label mb-0">
                  <i class="fas fa-calendar-alt me-1"></i>Competência (mês/ano)
                </label>
                <input type="month" id="id_mes_ano" name="mes_ano" class="form-control" value="{{ relatorio.competencia|default:'' }}">
              </div>
              <div class="col-auto">
                <label for="id_socio" class="form-label mb-0">
                  <i class="fas fa-user-md me-1"></i>Selecione o Sócio
                </label>
                <select id="id_socio" name="socio_id" class="form-select select2" style="width:100%;">
                  {% for socio in relatorio.socios %}
                    <option value="{{ socio.id }}" {% if socio.id == relatorio.socio_id %}selected{% endif %}>{{ socio.pessoa.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="fas fa-search me-1"></i>Filtrar
                </button>
              </div>
              <div class="col-auto">
                <a href="{% url 'medicos:relatorio_mensal_socio' empresa.id %}" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-1"></i>Limpar
                </a>
              </div>
            </div>
            
            <!-- Indicador visual do filtro ativo -->
            {% if relatorio.competencia %}
              <div class="mt-2">
                <small class="text-muted">
                  <i class="fas fa-filter me-1"></i>
                  Exibindo relatório de: <strong>{{ relatorio.competencia }}</strong> | Sócio: <strong>{{ relatorio.socio_nome }}</strong>
                </small>
              </div>
            {% endif %}
          </form>
          <h5 class="fw-bold mt-4 mb-2"><i class="fas fa-file-chart-line me-1"></i>Demonstrativo do Relatório Mensal</h5>
          <div class="table-responsive rounded shadow-sm p-3 bg-light">
            <div class="bg-white rounded-2 p-2">
              <div class="row g-4 mb-4">
                <div class="col-lg-6">
                  <div class="card shadow-sm border-primary">
                    <div class="card-header bg-primary bg-opacity-10 border-primary fw-bold px-3 py-2">
                      <span class="bi bi-table text-primary me-2"></span> Receitas
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped table-hover mb-0 w-auto" style="min-width:320px;max-width:430px;">
                          <tr><th colspan="2">RECEITA BRUTA RECEBIDA* (=)</th><th>{{ relatorio.receita_bruta_recebida|floatformat:2 }}</th></tr>
                          <tr><td>1</td><td>serviços de consultas e plantões</td><td>{{ relatorio.faturamento_consultas|default:0|floatformat:2 }}</td></tr>
                          <tr><td>2</td><td>Serviços de vacinação, exames, procedimentos</td><td>{{ relatorio.faturamento_outros|default:0|floatformat:2 }}</td></tr>
                          <tr class="linha-total"><th colspan="2">IMPOSTOS* (-)</th><th>{{ relatorio.impostos_total|floatformat:2 }}</th></tr>
                          <tr><td>1</td><td>PIS</td><td>{{ relatorio.total_pis|floatformat:2 }}</td></tr>
                          <tr><td>2</td><td>COFINS</td><td>{{ relatorio.total_cofins|floatformat:2 }}</td></tr>
                          <tr><td>3</td><td>IRPJ</td><td>{{ relatorio.total_irpj|floatformat:2 }}</td></tr>
                          <tr><td>4</td><td>CSLL</td><td>{{ relatorio.total_csll|floatformat:2 }}</td></tr>
                          <tr><td>5</td><td>ISSQN</td><td>{{ relatorio.total_iss|floatformat:2 }}</td></tr>
                          <tr class="linha-liquido"><th colspan="2">RECEITA LÍQUIDA (=)</th><th>{{ relatorio.receita_liquida|floatformat:2 }}</th></tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card shadow-sm border-success">
                    <div class="card-header bg-success bg-opacity-10 border-success fw-bold px-3 py-2">
                      <span class="bi bi-calculator text-success me-2"></span> Cálculo do Saldo Financeiro
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped table-hover mb-0 w-auto" style="min-width:320px;max-width:430px;">
                          <tr><th colspan="2">SALDO DAS MOVIMENTAÇÕES FINANCEIRAS (=)</th><th>{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</th></tr>
                          <tr class="linha-total"><th colspan="2">TOTAL DESPESAS (-)</th><th>{{ relatorio.despesas_total|floatformat:2 }}</th></tr>
                          <tr><td>1</td><td>Despesa com rateio</td><td>{{ relatorio.despesa_com_rateio|floatformat:2 }}</td></tr>
                          <tr><td>2</td><td>Despesa sem rateio</td><td>{{ relatorio.despesa_sem_rateio|floatformat:2 }}</td></tr>
                          <tr><th colspan="2">RATEIO MENSAL DO ADICIONAL DE IR (-)</th><th>{{ relatorio.total_irpj_adicional|floatformat:2 }}</th></tr>
                          <tr class="linha-total"><th colspan="2">SALDO A TRANSFERIR (=)</th><th>{{ relatorio.saldo_a_transferir|floatformat:2 }}</th></tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tabela de Movimentação Financeira posicionada abaixo do Demonstrativo -->
              <div class="row g-4 mb-4">
                <div class="col-12">
                  <div class="card shadow-sm border-secondary">
                    <div class="card-header bg-secondary bg-opacity-10 border-secondary fw-bold d-flex align-items-center">
                      <i class="fas fa-exchange-alt text-secondary me-2"></i>
                      <span>Movimentações Financeiras</span>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped table-hover mb-0 table-movimentacoes-financeiras" style="width:auto;">
                          <tr>
                            <th style="min-width:28px;max-width:32px;width:32px;">Id</th>
                            <th style="min-width:50px;max-width:60px;width:60px;">Data</th>
                            <th style="min-width:220px;max-width:320px;width:320px;">Descrição</th>
                            <th style="min-width:50px;max-width:60px;width:60px;">Valor total</th>
                          </tr>
                          {% for mov in relatorio.movimentacoes_financeiras %}
                          <tr>
                            <td>{{ mov.id }}</td>
                            <td>{{ mov.data }}</td>
                            <td>{{ mov.descricao }}</td>
                            <td>{{ mov.valor|floatformat:2 }}</td>
                          </tr>
                          {% endfor %}
                          <tr class="linha-total"><th colspan="3">Saldo</th><td>{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</td></tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card shadow-sm border-info mb-4">
                <div class="card-header bg-info bg-opacity-10 border-info fw-bold d-flex align-items-center">
                  <i class="fas fa-hand-holding-usd text-info me-2"></i>
                  <span>Relação de Despesas com Rateio</span>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive rounded shadow-sm p-3 bg-light">
                    <div class="bg-white rounded-2 p-2">
                      <table class="table table-sm table-bordered table-striped table-hover mb-0 w-auto table-despesas-com-rateio" style="width:100%;min-width:1200px;max-width:none;">
                        <tr>
                          <th style="min-width:110px;">Data</th>
                          <th style="min-width:180px;">Grupo da despesa</th>
                          <th style="min-width:260px;">Descrição</th>
                          <th style="min-width:120px;">Valor Despesa</th>
                          <th style="min-width:120px;">Percentual Rateio</th>
                          <th style="min-width:120px;">Valor Total</th>
                          <th style="min-width:120px;">Valor Sócio</th>
                        </tr>
                        {% for desp in relatorio.despesas_com_rateio|dictsort:"data" %}
                        <tr>
                          <td>{{ desp.data }}</td>
                          <td>{{ desp.grupo }}</td>
                          <td>{{ desp.descricao }}</td>
                          <td>{{ desp.valor_total|floatformat:2 }}</td>
                          <td>{{ desp.rateio_percentual|floatformat:2 }}%</td>
                          <td>{{ desp.valor_total|floatformat:2 }}</td>
                          <td>{{ desp.valor_socio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="linha-total"><th colspan="6">Total Sócio</th><td>{{ relatorio.despesa_com_rateio|floatformat:2 }}</td></tr>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <!-- Tabela de Despesa sem Rateio -->
              <div class="card shadow-sm border-warning mb-4">
                <div class="card-header bg-warning bg-opacity-10 border-warning fw-bold d-flex align-items-center">
                  <i class="fas fa-user-minus text-warning me-2"></i>
                  <span>Relação de Despesas sem Rateio</span>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive rounded shadow-sm p-3 bg-light">
                    <div class="bg-white rounded-2 p-2">
                      <table class="table table-sm table-bordered table-striped table-hover mb-0 w-auto" style="min-width:700px;max-width:1100px;">
                        <tr><th>Data</th><th>Grupo da despesa</th><th>Descrição</th><th>Valor</th></tr>
                        {% for desp in relatorio.despesas_sem_rateio|dictsort:"data" %}
                        <tr><td>{{ desp.data }}</td><td>{{ desp.grupo }}</td><td>{{ desp.descricao }}</td><td>{{ desp.valor|floatformat:2 }}</td></tr>
                        {% endfor %}
                        <tr class="linha-total"><th colspan="3">Total</th><td>{{ relatorio.despesa_sem_rateio|floatformat:2 }}</td></tr>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm border-warning mb-4">
            <div class="card-header bg-warning bg-opacity-10 border-warning fw-bold d-flex align-items-center">
              <i class="fas fa-file-invoice-dollar text-warning me-2"></i>
              <span>Notas Fiscais Recebidas no Mês</span>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive rounded shadow-sm p-3 bg-light">
                <div class="bg-white rounded-2 p-2">
                  <table class="table table-sm table-bordered table-striped table-hover mb-0" style="width:100%;min-width:1200px;max-width:none;">
                    <tr><th>Id</th><th>Número</th><th>Tp aliquota</th><th>Data Emissão</th><th>Data Recebimento</th><th>Fornecedor</th><th>Tomador</th><th>Valor bruto</th><th>ISS</th><th>PIS</th><th>COFINS</th><th>IRPJ</th><th>CSLL</th><th>Valor líquido</th></tr>
                    {% for nota in relatorio.notas_fiscais %}
                    <tr><td>{{ nota.id }}</td><td>{{ nota.numero }}</td><td>{{ nota.tp_aliquota }}</td><td>{{ nota.data_emissao }}</td><td>{{ nota.data_recebimento }}</td><td>{{ nota.fornecedor }}</td><td>{{ nota.tomador }}</td><td>{{ nota.valor_bruto|floatformat:2 }}</td><td>{{ nota.iss|floatformat:2 }}</td><td>{{ nota.pis|floatformat:2 }}</td><td>{{ nota.cofins|floatformat:2 }}</td><td>{{ nota.irpj|floatformat:2 }}</td><td>{{ nota.csll|floatformat:2 }}</td><td>{{ nota.valor_liquido|floatformat:2 }}</td></tr>
                    {% endfor %}
                    <tr class="linha-total"><th colspan="7">Totais</th>
                      <td>{{ relatorio.total_nf_valor_bruto|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_iss|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_pis|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_cofins|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_irpj|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_csll|floatformat:2 }}</td>
                      <td>{{ relatorio.total_nf_valor_liquido|floatformat:2 }}</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <footer class="text-center text-muted mt-5 mb-2" style="font-size:0.95rem;">Relatório gerado em {{ relatorio.data_geracao }}</footer>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Seção de Informações Complementares -->
  <div class="container mt-4 mb-5">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm border-info h-100">
          <div class="card-header bg-info bg-opacity-10 border-info fw-bold">
            <span class="bi bi-info-circle-fill text-info me-2"></span>Notas Gerais
          </div>
          <div class="card-body p-3">
            <ul class="mb-0 ps-3" style="font-size:1rem;">
              <li>Receita bruta recebida = considera data de recebimento da nota</li>
              <li>Impostos = considera data de emissão da nota</li>
              <li>Total notas emitidas no mês: <b>R$ {{ relatorio.total_notas_emitidas_mes|floatformat:2 }}</b> (considera data de emissão da nota)</li>
              <li>Total notas recebidas no mês (sócio): <b>R$ {{ relatorio.receita_bruta_recebida|floatformat:2 }}</b> (considera data de recebimento da nota)</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-primary h-100">
          <div class="card-header bg-primary bg-opacity-10 border-primary fw-bold">
            <span class="bi bi-calculator-fill text-primary me-2"></span>Nota sobre o Rateio de Adicional de IR Mensal
          </div>
          <div class="card-body p-3">
            <ul class="mb-0 ps-3" style="font-size:1rem;">
              <li>Rateio de adicional de IR mensal = considera data de emissão da nota para calcular receita bruta mensal</li>
              <li class="small text-muted">
                <b>Como é calculado o rateio de adicional de IR mensal?</b><br>
                1. Soma-se a receita bruta de todos os sócios no mês.<br>
                2. Se a soma ultrapassar o limite de isenção do adicional de IR (R$ {{ valor_base_adicional|floatformat:2 }}/mês), calcula-se o excedente.<br>
                3. Aplica-se a alíquota do adicional ({{ aliquota_adicional }}%) sobre o excedente.<br>
                4. O valor do adicional é rateado entre os sócios proporcionalmente à participação de cada um na receita do mês.<br>
                Exemplo: Se o sócio teve 60% da receita, recebe 60% do adicional.<br>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card border-primary shadow-sm mb-3 mt-4" style="max-width: 540px;">
      <div class="card-header bg-primary bg-opacity-10 border-primary fw-bold">
        <i class="fas fa-equals text-primary me-2"></i>
        Equação do Rateio Mensal de Adicional de IR
      </div>
      <div class="card-body p-3">
        <ul class="mb-2" style="font-size:1.05em;">
          <li><b>Receita bruta total da empresa no mês:</b> R$ {{ relatorio.total_notas_bruto|floatformat:2 }}</li>
          <li><b>Base das notas fiscais recebidas do tipo "consultas médicas":</b> R$ {{ relatorio.base_calculo_consultas|floatformat:2|default:"0,00" }}</li>
          <li><b>Base das notas fiscais recebidas do tipo "outros serviços":</b> R$ {{ relatorio.base_calculo_outros|floatformat:2|default:"0,00" }}</li>
          <li><b>Base de cálculo do IR (total):</b> R$ {{ relatorio.base_calculo_ir_total|floatformat:2|default:"0,00" }}</li>
          <li><b>Limite de isenção do adicional de IR:</b> R$ {{ valor_base_adicional|floatformat:2 }}</li>
          <li><b>Excedente sujeito ao adicional:</b> R$ {{ excedente_adicional|floatformat:2 }}</li>
          <li><b>Alíquota do adicional:</b> {{ aliquota_adicional }}%</li>
          <li><b>Valor total do adicional a ser rateado:</b> R$ {{ valor_adicional_rateio|floatformat:2 }}</li>
          <li><b>Participação do sócio na receita bruta da empresa:</b> {% if relatorio.total_notas_bruto > 0 %}{{ receita_bruta_socio|floatformat:2 }} / {{ relatorio.total_notas_bruto|floatformat:2 }} = {{ participacao_socio|floatformat:4 }}{% else %}0{% endif %}</li>
          <li><b>Valor do adicional para o sócio:</b> R$ {% if relatorio.total_notas_bruto > 0 %}{{ valor_adicional_rateio|floatformat:2 }} x ({{ receita_bruta_socio|floatformat:2 }} / {{ relatorio.total_notas_bruto|floatformat:2 }}) = {{ valor_adicional_socio|floatformat:2 }}{% else %}0,00{% endif %}</li>
        </ul>
        <div class="text-muted small">* Os valores reais são calculados conforme os dados do mês selecionado.</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block bl_script %}
<!-- Select2 assets e inicialização -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    $('#id_socio').select2({
      placeholder: "Selecione ou digite para filtrar...",
      allowClear: true,
      width: '100%',
      minimumInputLength: 1
    });
  });
</script>
<style>
  .select2-container--default .select2-results__option {
    color: #212529;
    background-color: #fff;
  }
  .select2-container--default .select2-selection__rendered {
    color: #212529;
  }
  /* Evitar quebra de linha na tabela de notas fiscais */
  .table-notas-fiscais td, .table-notas-fiscais th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-notas-fiscais th {
    min-width: 80px;
  }
  .table-notas-fiscais th:nth-child(2),
  .table-notas-fiscais th:nth-child(6),
  .table-notas-fiscais th:nth-child(7) {
    min-width: 120px;
  }
  /* Evitar quebra de linha e barra de rolagem na tabela de despesas com rateio */
  .table-despesas-com-rateio td, .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  /* Evitar quebra de linha e garantir largura mínima na tabela de movimentações financeiras */
  .table-movimentacoes-financeiras td, .table-movimentacoes-financeiras th {
    white-space: nowrap;
    vertical-align: middle;
    padding-left: 3px;
    padding-right: 3px;
    font-size: 0.95rem;
  }
  .table-movimentacoes-financeiras th {
    min-width: 30px;
  }
  .table-movimentacoes-financeiras th:nth-child(1) { min-width: 28px; max-width:32px; width:32px; }
  .table-movimentacoes-financeiras th:nth-child(2) { min-width: 50px; max-width:60px; width:60px; }
  .table-movimentacoes-financeiras th:nth-child(3) { min-width: 220px; max-width:320px; width:320px; }
  .table-movimentacoes-financeiras th:nth-child(4) { min-width: 50px; max-width:60px; width:60px; }
</style>
{% endblock %}
