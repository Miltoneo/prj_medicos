{% extends "layouts/base_cenario_demonstrativo.html" %}
{% block title %}Relatório Mensal do Sócio{% endblock %}

{% block extra_css %}
<style>
    .valor-monetario {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
    }
    .valor-monetario-header {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
        color: #1e3a5f !important;
        font-size: 1rem;
    }
    .table-secondary th.valor-monetario-header,
    .table-secondary th[style*="Courier"] {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
        color: #1e3a5f !important;
    }
    /* Aplicar estilo Courier New a toda a terceira coluna da tabela de receitas */
    .table td:nth-child(3),
    .table th:nth-child(3) {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
    }
    .card-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.02);
    }
    .card-estatistica {
        transition: transform 0.2s;
    }
    .card-estatistica:hover {
        transform: translateY(-2px);
    }
    .filtro-competencia {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        border: none !important;
    }
    .filtro-competencia h4,
    .filtro-competencia span,
    .filtro-competencia .text-white {
        color: #ffffff !important;
        opacity: 1 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
    }
    .col-financeira-destaque {
        background: linear-gradient(135deg, #6f42c1 0%, #495057 100%) !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-submit do formulário de filtro quando campos forem alterados
  const formFields = document.querySelectorAll('#id_socio, #id_mes_ano');
  formFields.forEach(function(field) {
    if (field) {
      field.addEventListener('change', function() {
        // Submete o formulário automaticamente quando um campo é alterado
        this.closest('form').submit();
      });
    }
  });
  
  // Se a página foi carregada sem parâmetros de filtro, garantir que o mês atual esteja selecionado
  const mesAnoField = document.getElementById('id_mes_ano');
  if (mesAnoField) {
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilterParams = urlParams.has('mes_ano') || urlParams.has('socio_id');
    
    if (!hasFilterParams && !mesAnoField.value) {
      // Define o mês atual se não há valor
      const today = new Date();
      const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      mesAnoField.value = currentMonth;
      
      // Submete automaticamente para aplicar o filtro do mês atual
      setTimeout(() => {
        mesAnoField.closest('form').submit();
      }, 100);
    }
  }
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4 w-100" style="max-width:none;">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="fas fa-user-friends me-2 text-light"></i>
          <span class="fw-bold">Relatório Mensal do Sócio</span>
        </div>
        <div class="card-body">
          {% if empresa %}
            <div class="mb-3">
              <span class="fw-bold">Empresa:</span> {{ empresa.nome_fantasia|default:empresa.name }}
            </div>
          {% else %}
            <div class="mb-3">
              <span class="fw-bold text-danger">Empresa não selecionada</span>
            </div>
          {% endif %}
          <form method="get" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label for="id_mes_ano" class="form-label mb-0">
                  <i class="fas fa-calendar-alt me-1 text-primary"></i>Competência (mês/ano)
                </label>
                <input type="month" id="id_mes_ano" name="mes_ano" class="form-control" value="{{ relatorio.competencia|default:'' }}">
              </div>
              <div class="col-auto">
                <label for="id_socio" class="form-label mb-0">
                  <i class="fas fa-user-md me-1 text-success"></i>Selecione o Sócio
                </label>
                <select id="id_socio" name="socio_id" class="form-select select2" style="width:100%;">
                  {% for socio in relatorio.socios %}
                    <option value="{{ socio.id }}" {% if socio.id == relatorio.socio_id %}selected{% endif %}>{{ socio.pessoa.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="fas fa-search me-1 text-primary"></i>Filtrar
                </button>
              </div>
              <div class="col-auto">
                <a href="{% url 'medicos:relatorio_mensal_socio' empresa.id %}" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-1 text-secondary"></i>Limpar
                </a>
              </div>
              
          </form>
          
          <div class="table-responsive rounded shadow-sm p-3 bg-light">
            <div class="bg-white rounded-2 p-2">
              <div class="row g-4 mb-4">
                <div class="col-lg-6">
                  <div class="card shadow-sm">
                    <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                      <div class="d-flex align-items-center">
                        <span class="bi bi-table me-2" style="color: #ffffff !important; font-size: 1.1em;"></span>
                        <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Receitas</h4>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 w-auto" style="min-width:320px;max-width:430px;">
                          <thead>
                            <tr class="table-secondary">
                              <th style="width: 75%;">Descrição</th>
                              <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; color: #1e3a5f !important;">Valor</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>(=) RECEITA BRUTA RECEBIDA</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.receita_bruta_recebida|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><td>serviços de consultas e plantões</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.faturamento_consultas|default:0|floatformat:2 }}</td></tr>
                            <tr><td>Serviços de vacinação, exames, procedimentos</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.faturamento_outros|default:0|floatformat:2 }}</td></tr>
                          </tbody>
                          <thead>
                            <tr class="table-success">
                              <th>(-) IMPOSTO DEVIDO(a)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.impostos_devido_total|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-warning">
                              <th>(-) ADICIONAL DE IR TRIMESTRAL</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj_adicional|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>(=) RECEITA LÍQUIDA</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.receita_liquida|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><th>(-) DESPESAS</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_geral|floatformat:2 }}</th></tr>
                            <tr><td>Despesa com rateio</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_com_rateio|floatformat:2 }}</td></tr>
                            <tr><td>Despesa sem rateio</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_sem_rateio|floatformat:2 }}</td></tr>
                            <tr><th>(+) SALDO DAS MOVIMENTAÇÕES FINANCEIRAS</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</th></tr>
                          </tbody>
                          <thead>
                            <tr style="background-color: #343a40 !important; color: white !important;">
                              <th style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">(=) SALDO A TRANSFERIR</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.saldo_a_transferir|floatformat:2 }}</th>
                            </tr>
                          </thead>
                        </table>
                      </div>
                      <div class="mt-3">
                        <div class="alert alert-info alert-sm mb-0" style="font-size: 0.875rem; padding: 0.5rem;">
                          <i class="fas fa-info-circle me-2"></i>
                          <strong>Notas:</strong><br>
                          a) Impostos a provisionar: lançados automaticamente no dia 15 do mês seguinte.<br>
                          Ver abaixo a tabela: Espelho Cálculo de Impostos.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tabela de Movimentação Financeira posicionada abaixo do Demonstrativo -->
              <div class="row g-4 mb-4">
                <div class="col-12">
                  <div class="card shadow-sm">
                    <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-exchange-alt me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                        <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Movimentações Financeiras</h4>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 table-movimentacoes-financeiras" style="width:auto;">
                          <thead>
                            <tr class="table-success">
                              <th style="min-width:28px;max-width:32px;width:32px;">Id</th>
                              <th style="min-width:50px;max-width:60px;width:60px;">Data</th>
                              <th style="min-width:220px;max-width:320px;width:320px;">Descrição</th>
                              <th style="min-width:50px;max-width:60px;width:60px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for mov in relatorio.movimentacoes_financeiras %}
                            <tr>
                              <td>{{ mov.id }}</td>
                              <td>{{ mov.data }}</td>
                              <td>{{ mov.descricao }}</td>
                              <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ mov.valor|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                            <tr style="background-color: #343a40 !important; color: white !important;"><th colspan="3" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Saldo</th><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-4 mb-4">
            <!-- Tabela de Despesas Apropriadas -->
          <div class="col-12">
            <div class="card shadow-sm mb-4">
              <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                <div class="d-flex align-items-center">
                  <i class="fas fa-calculator me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                  <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Despesas Apropriadas</h4>
                </div>
              </div>
              <div class="card-body p-4">
                {% if relatorio.despesas_apropriadas %}
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" style="min-width:800px;">
                      <thead>
                        <tr class="table-success">
                          <th>Data</th>
                          <th>Descrição</th>
                          <th>Grupo</th>
                          <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor Total</th>
                          <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Taxa Rateio (%)</th>
                          <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor Apropriado</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for despesa in relatorio.despesas_apropriadas %}
                        <tr>
                          <td>{{ despesa.data|date:"d/m/Y" }}</td>
                          <td>{{ despesa.descricao }}</td>
                          <td>{{ despesa.grupo }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">R$ {{ despesa.valor_total|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">
                            {% if despesa.taxa_rateio == '-' %}-{% else %}{{ despesa.taxa_rateio|floatformat:2 }}{% endif %}
                          </td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">R$ {{ despesa.valor_apropriado|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                        <tr style="background-color: #343a40 !important; color: white !important;">
                          <th colspan="5" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Total</th>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">R$ {{ relatorio.total_despesas_apropriadas|floatformat:2 }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="alert alert-info">Nenhuma despesa apropriada encontrada para o sócio neste período.</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm mb-4">
            <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
              <div class="d-flex align-items-center">
                <i class="fas fa-file-invoice-dollar me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Notas Fiscais Recebidas no Mês</h4>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="table-responsive rounded shadow-sm p-3 bg-light">
                <div class="bg-white rounded-2 p-2">
                  <table class="table table-sm table-bordered table-striped table-hover mb-0" style="width:100%;min-width:1200px;max-width:none;">
                    <thead>
                      <tr class="table-success">
                        <th>Id</th><th>Número</th><th>Tp aliquota</th><th>Data Emissão</th><th>Data Recebimento</th><th>Tomador</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">% Rateio</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor bruto</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">ISS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">PIS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">COFINS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">IRPJ</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">CSLL</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Outros</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor líquido</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for nota in relatorio.notas_fiscais %}
                      <tr>
                        <td>{{ nota.id }}</td><td>{{ nota.numero }}</td><td>{{ nota.tp_aliquota }}</td><td>{{ nota.data_emissao }}</td><td>{{ nota.data_recebimento }}</td><td>{{ nota.tomador }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.percentual_rateio|floatformat:2 }}%</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_bruto|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.iss|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.pis|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.cofins|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.irpj|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.csll|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.outros|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_liquido|floatformat:2 }}</td>
                      </tr>
                      {% endfor %}
                      <tr style="background-color: #343a40 !important; color: white !important;">
                        <th colspan="7" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Totais</th>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_valor_bruto|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_iss|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_pis|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_cofins|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_irpj|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_csll|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_outros|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_valor_liquido|floatformat:2 }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabela: Notas Fiscais Emitidas no Mês -->
          <div class="card shadow-sm mb-4">
            <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
              <div class="d-flex align-items-center">
                <i class="fas fa-file-invoice me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Notas Fiscais Emitidas no Mês</h4>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" style="width:100%;min-width:1200px;max-width:none;">
                  <thead>
                    <tr class="table-success">
                      <th>Id</th><th>Número</th><th>Tp aliquota</th><th>Data Emissão</th><th>Data Recebimento</th><th>Tomador</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">% Rateio</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor bruto</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">ISS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">PIS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">COFINS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">IRPJ</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">CSLL</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Outros</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor líquido</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for nota in relatorio.notas_fiscais_emitidas %}
                    <tr>
                      <td>{{ nota.id }}</td><td>{{ nota.numero }}</td><td>{{ nota.tp_aliquota }}</td><td>{{ nota.data_emissao }}</td><td>{{ nota.data_recebimento }}</td><td>{{ nota.tomador }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.percentual_rateio|floatformat:2 }}%</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_bruto|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.iss|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.pis|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.cofins|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.irpj|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.csll|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.outros|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_liquido|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                    <tr style="background-color: #343a40 !important; color: white !important;">
                      <th colspan="7" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Totais</th>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_valor_bruto|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_iss|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_pis|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_cofins|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_irpj|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_csll|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_outros|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_valor_liquido|floatformat:2 }}</td>
                    </tr>
                  </tbody>
                  </table>
              </div>
            </div>
          </div>
          <footer class="text-center text-muted mt-5 mb-2" style="font-size:0.95rem;">Relatório gerado em {{ relatorio.data_geracao }}</footer>
          
          <!-- Seção de Informações Complementares integrada -->
          <div class="row g-3 mt-4">
            
            <div class="col-md-6">
              <!-- Espelho Cálculo de Impostos -->
              <div class="card shadow-sm border-success h-100">
                <div class="card-header bg-success bg-opacity-10 border-success fw-bold">
                  <i class="fas fa-calculator text-success me-2"></i>
                  <span>Espelho Cálculo de Impostos</span>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped table-hover mb-0" style="min-width:480px;max-width:600px;">
                      <thead class="table-success">
                        <tr>
                          <th style="width: 25%;" class="text-center">Imposto</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Devido</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Retido</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">A Pagar</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="table-info">
                          <td class="fw-bold">Base Consultas Médicas</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ base_consultas_socio_regime|floatformat:2|default:"0,00" }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                        </tr>
                        <tr class="table-info">
                          <td class="fw-bold">Base Outros Serviços</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ base_outros_socio_regime|floatformat:2|default:"0,00" }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">PIS ({{ aliquota_pis|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">COFINS ({{ aliquota_cofins|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">IRPJ ({{ aliquota_irpj|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">CSLL ({{ aliquota_csll|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">ISSQN ({{ aliquota_iss|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss|floatformat:2 }}</td>
                        </tr>
                        <tr style="background-color: #343a40 !important; color: white !important;">
                          <td class="fw-bold" style="background-color: #343a40 !important; color: white !important;">TOTAL</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_devido_total|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_retido_total|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_total|floatformat:2 }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="px-3 py-2">
                    <small class="text-muted fst-italic">* Cálculo imposto: por data de emissão da nota (regime competência) / por data de recebimento (regime caixa)</small>
                  </div>
                  
                  <!-- Botão para lançamento automático dos impostos -->
                  {% if relatorio.impostos_total > 0 %}
                  <div class="px-3 pb-3">
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-1 text-primary">
                          <i class="fas fa-university me-2"></i>Lançamento Automático na Conta Corrente
                        </h6>
                        <small class="text-muted">Os impostos serão lançados automaticamente no mês seguinte durante o cálculo</small>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block bl_script %}
<!-- Select2 assets e inicialização -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    $('#id_socio').select2({
      placeholder: "Selecione ou digite para filtrar...",
      allowClear: true,
      width: '100%',
      minimumInputLength: 1
    });
  });
</script>
<style>
  .select2-container--default .select2-results__option {
    color: #212529;
    background-color: #fff;
  }
  .select2-container--default .select2-selection__rendered {
    color: #212529;
  }
  /* Evitar quebra de linha na tabela de notas fiscais */
  .table-notas-fiscais td, .table-notas-fiscais th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-notas-fiscais th {
    min-width: 80px;
  }
  .table-notas-fiscais th:nth-child(2),
  .table-notas-fiscais th:nth-child(6),
  .table-notas-fiscais th:nth-child(7) {
    min-width: 120px;
  }
  /* Evitar quebra de linha e barra de rolagem na tabela de despesas com rateio */
  .table-despesas-com-rateio td, .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  /* Evitar quebra de linha e garantir largura mínima na tabela de movimentações financeiras */
  .table-movimentacoes-financeiras td, .table-movimentacoes-financeiras th {
    white-space: nowrap;
    vertical-align: middle;
    padding-left: 3px;
    padding-right: 3px;
    font-size: 0.95rem;
  }
  .table-movimentacoes-financeiras th {
    min-width: 30px;
  }
  .table-movimentacoes-financeiras th:nth-child(1) { min-width: 28px; max-width:32px; width:32px; }
  .table-movimentacoes-financeiras th:nth-child(2) { min-width: 50px; max-width:60px; width:60px; }
  .table-movimentacoes-financeiras th:nth-child(3) { min-width: 220px; max-width:320px; width:320px; }
  .table-movimentacoes-financeiras th:nth-child(4) { min-width: 50px; max-width:60px; width:60px; }
</style>
{% endblock %}
