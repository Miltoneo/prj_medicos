{% extends "layouts/base_cenario_demonstrativo.html" %}
{% block title %}Relat√≥rio Mensal do S√≥cio{% endblock %}

{% block extra_css %}
<style>
    .valor-monetario {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
    }
    .valor-monetario-header {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
        color: #1e3a5f !important;
        font-size: 1rem;
    }
    .table-secondary th.valor-monetario-header,
    .table-secondary th[style*="Courier"] {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
        color: #1e3a5f !important;
    }
    /* Aplicar estilo Courier New a toda a terceira coluna da tabela de receitas */
    .table td:nth-child(3),
    .table th:nth-child(3) {
        font-family: 'Courier New', monospace !important;
        font-weight: 500 !important;
        text-align: right !important;
    }
    .card-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.02);
    }
    .card-estatistica {
        transition: transform 0.2s;
    }
    .card-estatistica:hover {
        transform: translateY(-2px);
    }
    .filtro-competencia {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        border: none !important;
    }
    .filtro-competencia h4,
    .filtro-competencia span,
    .filtro-competencia .text-white {
        color: #ffffff !important;
        opacity: 1 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
    }
    .col-financeira-destaque {
        background: linear-gradient(135deg, #6f42c1 0%, #495057 100%) !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Auto-submit do formul√°rio de filtro quando campos forem alterados
  const formFields = document.querySelectorAll('#id_socio, #id_mes_ano');
  formFields.forEach(function(field) {
    if (field) {
      field.addEventListener('change', function() {
        // Submete o formul√°rio automaticamente quando um campo √© alterado
        this.closest('form').submit();
      });
    }
  });
  
  // Se a p√°gina foi carregada sem par√¢metros de filtro, garantir que o m√™s atual esteja selecionado
  const mesAnoField = document.getElementById('id_mes_ano');
  if (mesAnoField) {
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilterParams = urlParams.has('mes_ano') || urlParams.has('socio_id');
    
    if (!hasFilterParams && !mesAnoField.value) {
      // Define o m√™s atual se n√£o h√° valor
      const today = new Date();
      const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      mesAnoField.value = currentMonth;
      
      // Submete automaticamente para aplicar o filtro do m√™s atual
      setTimeout(() => {
        mesAnoField.closest('form').submit();
      }, 100);
    }
  }
  
  // Controlar exibi√ß√£o das op√ß√µes avan√ßadas de lan√ßamento autom√°tico
  const autoLancarCheckbox = document.getElementById('auto_lancar_impostos');
  const opcoesAvancadas = document.getElementById('opcoes-avancadas');
  
  if (autoLancarCheckbox && opcoesAvancadas) {
    autoLancarCheckbox.addEventListener('change', function() {
      if (this.checked) {
        opcoesAvancadas.style.display = 'block';
      } else {
        opcoesAvancadas.style.display = 'none';
      }
    });
  }
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4 w-100" style="max-width:none;">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="fas fa-user-friends me-2 text-light"></i>
          <span class="fw-bold">Relat√≥rio Mensal do S√≥cio</span>
        </div>
        <div class="card-body">
          {% if empresa %}
            <div class="mb-3">
              <span class="fw-bold">Empresa:</span> {{ empresa.nome_fantasia|default:empresa.name }}
            </div>
          {% else %}
            <div class="mb-3">
              <span class="fw-bold text-danger">Empresa n√£o selecionada</span>
            </div>
          {% endif %}
          <form method="get" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label for="id_mes_ano" class="form-label mb-0">
                  <i class="fas fa-calendar-alt me-1 text-primary"></i>Compet√™ncia (m√™s/ano)
                </label>
                <input type="month" id="id_mes_ano" name="mes_ano" class="form-control" value="{{ relatorio.competencia|default:'' }}">
              </div>
              <div class="col-auto">
                <label for="id_socio" class="form-label mb-0">
                  <i class="fas fa-user-md me-1 text-success"></i>Selecione o S√≥cio
                </label>
                <select id="id_socio" name="socio_id" class="form-select select2" style="width:100%;">
                  {% for socio in relatorio.socios %}
                    <option value="{{ socio.id }}" {% if socio.id == relatorio.socio_id %}selected{% endif %}>{{ socio.pessoa.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="fas fa-search me-1 text-primary"></i>Filtrar
                </button>
              </div>
              <div class="col-auto">
                <a href="{% url 'medicos:relatorio_mensal_socio' empresa.id %}" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-1 text-secondary"></i>Limpar
                </a>
              </div>
              
          </form>
          
          <!-- Configura√ß√µes de Lan√ßamento Autom√°tico -->
          {% if socio_selecionado %}
          <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="fas fa-university me-2"></i>Lan√ßamento Autom√°tico na Conta Corrente</h5>
            </div>
            <div class="card-body">
              <form method="get" id="form-lancamento-automatico">
                <!-- Campos ocultos para manter filtros -->
                <input type="hidden" name="socio_id" value="{{ request.GET.socio_id }}">
                <input type="hidden" name="mes_ano" value="{{ request.GET.mes_ano }}">
                
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" 
                             name="auto_lancar_impostos" value="true" 
                             id="auto_lancar_impostos"
                             {% if request.GET.auto_lancar_impostos == 'true' %}checked{% endif %}>
                      <label class="form-check-label" for="auto_lancar_impostos">
                        <strong>ü§ñ Lan√ßar impostos automaticamente na conta corrente</strong>
                      </label>
                      <div class="form-text">
                        Quando ativado, os impostos calculados ser√£o automaticamente lan√ßados como 
                        d√©bitos na conta corrente do s√≥cio no m√™s seguinte (dia 15).
                      </div>
                    </div>
                    
                    <div class="form-check form-switch mt-2" id="opcoes-avancadas" 
                         style="{% if request.GET.auto_lancar_impostos != 'true' %}display:none;{% endif %}">
                      <input class="form-check-input" type="checkbox" 
                             name="atualizar_lancamentos" value="true" 
                             id="atualizar_lancamentos"
                             {% if request.GET.atualizar_lancamentos != 'false' %}checked{% endif %}>
                      <label class="form-check-label" for="atualizar_lancamentos">
                        <strong>üîÑ Atualizar lan√ßamentos existentes</strong>
                      </label>
                      <div class="form-text">
                        Se j√° existirem lan√ßamentos para este per√≠odo, eles ser√£o atualizados com os novos valores.
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4 text-end">
                    <button type="submit" class="btn btn-info">
                      <i class="fas fa-sync-alt me-1"></i>Atualizar Relat√≥rio
                    </button>
                  </div>
                </div>
              </form>
              
              <!-- Resultado do Lan√ßamento Autom√°tico -->
              {% if resultado_lancamento_automatico %}
              <div class="mt-3">
                {% if resultado_lancamento_automatico.success %}
                <div class="alert alert-success">
                  <h6><i class="fas fa-check-circle me-2"></i>Lan√ßamentos Processados com Sucesso!</h6>
                  <ul class="mb-0">
                    {% if resultado_lancamento_automatico.lancamentos_criados > 0 %}
                    <li><strong>{{ resultado_lancamento_automatico.lancamentos_criados }}</strong> lan√ßamento(s) criado(s)</li>
                    {% endif %}
                    {% if resultado_lancamento_automatico.lancamentos_atualizados > 0 %}
                    <li><strong>{{ resultado_lancamento_automatico.lancamentos_atualizados }}</strong> lan√ßamento(s) atualizado(s)</li>
                    {% endif %}
                    {% if resultado_lancamento_automatico.lancamentos_removidos > 0 %}
                    <li><strong>{{ resultado_lancamento_automatico.lancamentos_removidos }}</strong> lan√ßamento(s) removido(s)</li>
                    {% endif %}
                    <li><strong>Total lan√ßado:</strong> R$ {{ resultado_lancamento_automatico.total_lancado|floatformat:2 }}</li>
                    <li><strong>Data de lan√ßamento:</strong> {{ resultado_lancamento_automatico.data_lancamento|date:"d/m/Y" }}</li>
                    <li><strong>Compet√™ncia:</strong> {{ resultado_lancamento_automatico.competencia }}</li>
                  </ul>
                </div>
                {% else %}
                <div class="alert alert-danger">
                  <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro no Lan√ßamento Autom√°tico</h6>
                  <p class="mb-0">{{ resultado_lancamento_automatico.error }}</p>
                </div>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          <!-- Configura√ß√µes de Lan√ßamento Autom√°tico -->
          <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configura√ß√µes de Lan√ßamento Autom√°tico</h5>
            </div>
            <div class="card-body">
              <form method="get" id="form-lancamento-automatico">
                <!-- Campos ocultos para manter filtros -->
                <input type="hidden" name="socio_id" value="{{ request.GET.socio_id }}">
                <input type="hidden" name="mes_ano" value="{{ request.GET.mes_ano }}">
                
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" 
                             name="auto_lancar_impostos" value="true" 
                             id="auto_lancar_impostos"
                             {% if request.GET.auto_lancar_impostos == 'true' %}checked{% endif %}
                             onchange="document.getElementById('form-lancamento-automatico').submit();">
                      <label class="form-check-label" for="auto_lancar_impostos">
                        <i class="fas fa-magic me-2 text-primary"></i>
                        <strong>Lan√ßar impostos automaticamente na conta corrente</strong>
                      </label>
                    </div>
                    <small class="text-muted ms-4">
                      Os impostos a provisionar ser√£o lan√ßados automaticamente no dia 15 do m√™s seguinte
                    </small>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" 
                             name="atualizar_lancamentos" value="true" 
                             id="atualizar_lancamentos"
                             {% if request.GET.atualizar_lancamentos != 'false' %}checked{% endif %}
                             {% if request.GET.auto_lancar_impostos != 'true' %}disabled{% endif %}>
                      <label class="form-check-label" for="atualizar_lancamentos">
                        <i class="fas fa-sync me-2 text-warning"></i>
                        Atualizar lan√ßamentos existentes
                      </label>
                    </div>
                    <small class="text-muted ms-4">
                      Se desmarcado, mant√©m lan√ßamentos existentes inalterados
                    </small>
                  </div>
                </div>
                
                <!-- Resultado do Lan√ßamento Autom√°tico -->
                {% if resultado_lancamento_automatico %}
                <div class="mt-3">
                  <div class="alert alert-{% if resultado_lancamento_automatico.success %}success{% else %}danger{% endif %} mb-0">
                    {% if resultado_lancamento_automatico.success %}
                      <h6 class="alert-heading mb-2">
                        <i class="fas fa-check-circle me-2"></i>Lan√ßamentos Processados com Sucesso!
                      </h6>
                      <div class="row">
                        <div class="col-md-6">
                          <ul class="mb-0">
                            <li><strong>Criados:</strong> {{ resultado_lancamento_automatico.lancamentos_criados }}</li>
                            <li><strong>Atualizados:</strong> {{ resultado_lancamento_automatico.lancamentos_atualizados }}</li>
                            <li><strong>Removidos:</strong> {{ resultado_lancamento_automatico.lancamentos_removidos }}</li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <ul class="mb-0">
                            <li><strong>Total Lan√ßado:</strong> R$ {{ resultado_lancamento_automatico.total_lancado|floatformat:2 }}</li>
                            <li><strong>Data de Lan√ßamento:</strong> {{ resultado_lancamento_automatico.data_lancamento|date:"d/m/Y" }}</li>
                            <li><strong>Compet√™ncia:</strong> {{ resultado_lancamento_automatico.competencia }}</li>
                          </ul>
                        </div>
                      </div>
                    {% else %}
                      <h6 class="alert-heading mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>Erro no Lan√ßamento Autom√°tico
                      </h6>
                      <p class="mb-0">{{ resultado_lancamento_automatico.error }}</p>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
                
              </form>
            </div>
          </div>
          
          <div class="table-responsive rounded shadow-sm p-3 bg-light">
            <div class="bg-white rounded-2 p-2">
              <div class="row g-4 mb-4">
                <div class="col-lg-6">
                  <div class="card shadow-sm">
                    <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                      <div class="d-flex align-items-center">
                        <span class="bi bi-table me-2" style="color: #ffffff !important; font-size: 1.1em;"></span>
                        <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Receitas</h4>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 w-auto" style="min-width:320px;max-width:430px;">
                          <thead>
                            <tr class="table-secondary">
                              <th style="width: 75%;">Descri√ß√£o</th>
                              <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; color: #1e3a5f !important;">Valor</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>RECEITA BRUTA RECEBIDA* (r)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.receita_bruta_recebida|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><td>servi√ßos de consultas e plant√µes</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.faturamento_consultas|default:0|floatformat:2 }}</td></tr>
                            <tr><td>Servi√ßos de vacina√ß√£o, exames, procedimentos</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.faturamento_outros|default:0|floatformat:2 }}</td></tr>
                          </tbody>
                          <thead>
                            <tr class="table-success">
                              <th>IMPOSTO DEVIDO*(a)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.impostos_devido_total|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>IMPOSTO RETIDO*(b)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.impostos_retido_total|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>IMPOSTO A PROVISIONAR*(c=a-b)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.impostos_total|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <thead>
                            <tr class="table-success">
                              <th>RECEITA L√çQUIDA (r-a)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.receita_liquida|floatformat:2 }}</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><th>DESPESAS (-)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_geral|floatformat:2 }}</th></tr>
                            <tr><td>Despesa com rateio</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_com_rateio|floatformat:2 }}</td></tr>
                            <tr><td>Despesa sem rateio</td><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.despesa_sem_rateio|floatformat:2 }}</td></tr>
                            <tr><th>SALDO DAS MOVIMENTA√á√ïES FINANCEIRAS (+)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</th></tr>
                          </tbody>
                          <thead>
                            <tr style="background-color: #343a40 !important; color: white !important;">
                              <th style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">SALDO A TRANSFERIR (=)</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.saldo_a_transferir|floatformat:2 }}</th>
                            </tr>
                          </thead>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card shadow-sm">
                    <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                      <div class="d-flex align-items-center">
                        <span class="bi bi-calculator me-2" style="color: #ffffff !important; font-size: 1.1em;"></span>
                        <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Resumo Conta Corrente</h4>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 w-auto" style="min-width:320px;max-width:430px;">
                          <thead>
                            <tr class="table-success">
                              <th>Descri√ß√£o</th>
                              <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><th>SALDO ANTERIOR (=)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ saldo_anterior|floatformat:2 }}</th></tr>
                            <tr><th>TOTAL CR√âDITOS (+)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ total_creditos_conta_corrente|floatformat:2 }}</th></tr>
                            <tr><th>TOTAL D√âBITOS (-)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ total_debitos_conta_corrente|floatformat:2 }}</th></tr>
                            <tr style="background-color: #343a40 !important; color: white !important;"><th style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">SALDO CONTA CORRENTE (=)</th><th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ saldo_conta_corrente|floatformat:2 }}</th></tr>
                            {% if mes_fechado %}
                            <tr><th colspan="2" class="text-success text-center">‚úì Per√≠odo Fechado</th></tr>
                            {% else %}
                            <tr><th colspan="2" class="text-warning text-center">‚ö† Per√≠odo N√£o Fechado</th></tr>
                            {% endif %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tabela de Movimenta√ß√£o Financeira posicionada abaixo do Demonstrativo -->
              <div class="row g-4 mb-4">
                <div class="col-12">
                  <div class="card shadow-sm">
                    <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-exchange-alt me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                        <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Movimenta√ß√µes Financeiras</h4>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 table-movimentacoes-financeiras" style="width:auto;">
                          <thead>
                            <tr class="table-success">
                              <th style="min-width:28px;max-width:32px;width:32px;">Id</th>
                              <th style="min-width:50px;max-width:60px;width:60px;">Data</th>
                              <th style="min-width:220px;max-width:320px;width:320px;">Descri√ß√£o</th>
                              <th style="min-width:50px;max-width:60px;width:60px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for mov in relatorio.movimentacoes_financeiras %}
                            <tr>
                              <td>{{ mov.id }}</td>
                              <td>{{ mov.data }}</td>
                              <td>{{ mov.descricao }}</td>
                              <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ mov.valor|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                            <tr style="background-color: #343a40 !important; color: white !important;"><th colspan="3" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Saldo</th><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.saldo_movimentacao_financeira|floatformat:2 }}</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
                <!-- Tabela: Extrato Conta Corrente -->
                <div class="row g-4 mb-4">
                  <div class="col-12">
                    <div class="card shadow-sm">
                      <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-university me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                          <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Extrato Conta Corrente</h4>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <!-- Resumo da Conta Corrente -->
                        <div class="row mb-4">
                          <div class="col-12">
                            <div class="table-responsive">
                              <table class="table table-sm table-bordered mb-3" style="max-width: 600px;">
                                <thead>
                                  <tr class="table-secondary">
                                    <th style="width: 50%;">Descri√ß√£o</th>
                                    <th style="width: 50%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>SALDO ANTERIOR (=)</td>
                                    <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ saldo_anterior|floatformat:2 }}</td>
                                  </tr>
                                  <tr>
                                    <td>TOTAL CR√âDITOS (+)</td>
                                    <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ total_creditos_conta_corrente|floatformat:2 }}</td>
                                  </tr>
                                  <tr>
                                    <td>TOTAL D√âBITOS (-)</td>
                                    <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ total_debitos_conta_corrente|floatformat:2 }}</td>
                                  </tr>
                                  <tr style="background-color: #343a40 !important; color: white !important;">
                                    <td style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">SALDO CONTA CORRENTE (=)</td>
                                    <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ saldo_conta_corrente|floatformat:2 }}</td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Extrato Detalhado -->
                        <div class="table-responsive">
                          <table class="table table-striped table-hover mb-0 table-movimentacoes-conta-corrente" style="width:auto;">
                            <thead>
                              <tr class="table-success">
                                <th>Id</th>
                                <th>Data</th>
                                <th>Nota Fiscal</th>
                                <th>Descri√ß√£o</th>
                                <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor</th>
                                <th>Instrumento Banc√°rio</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for mov in relatorio.movimentacoes_conta_corrente %}
                              <tr>
                                <td>{{ mov.id }}</td>
                                <td>{{ mov.data_movimentacao|date:"d/m/Y" }}</td>
                                <td>
                                  {% if mov.nota_fiscal %}
                                    NF {{ mov.nota_fiscal.numero }}
                                  {% else %}
                                    ‚Äî
                                  {% endif %}
                                </td>
                                <td>{{ mov.descricao_movimentacao }}</td>
                                <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">
                                  {% if mov.valor > 0 %}
                                    <span class="text-success fw-bold">{{ mov.valor|floatformat:2 }}</span>
                                  {% else %}
                                    <span class="text-danger fw-bold">{{ mov.valor|floatformat:2 }}</span>
                                  {% endif %}
                                </td>
                                <td>{{ mov.instrumento_bancario }}</td>
                              </tr>
                              {% empty %}
                              <tr>
                                <td colspan="6" class="text-center text-muted">Nenhuma movimenta√ß√£o encontrada.</td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card shadow-sm mb-4">
                <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-hand-holding-usd me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                    <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Rela√ß√£o de Despesas com Rateio</h4>
                  </div>
                </div>
                <div class="card-body p-4">
                  <div class="table-responsive">
                      <table class="table table-striped table-hover mb-0 w-auto table-despesas-com-rateio" style="width:100%;min-width:1200px;max-width:none;">
                        <thead>
                          <tr class="table-success">
                            <th style="min-width:110px;">Data</th>
                            <th style="min-width:180px;">Grupo da despesa</th>
                            <th style="min-width:260px;">Descri√ß√£o</th>
                            <th style="min-width:120px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor Despesa</th>
                            <th style="min-width:120px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Percentual Rateio</th>
                            <th style="min-width:120px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor Total</th>
                            <th style="min-width:120px; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor S√≥cio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for desp in relatorio.despesas_com_rateio|dictsort:"data" %}
                          <tr>
                            <td>{{ desp.data }}</td>
                            <td>{{ desp.grupo }}</td>
                            <td>{{ desp.descricao }}</td>
                            <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ desp.valor_total|floatformat:2 }}</td>
                            <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ desp.rateio_percentual|floatformat:2 }}%</td>
                            <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ desp.valor_total|floatformat:2 }}</td>
                            <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ desp.valor_socio|floatformat:2 }}</td>
                          </tr>
                          {% endfor %}
                          <tr style="background-color: #343a40 !important; color: white !important;"><th colspan="6" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Total S√≥cio</th><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.despesa_com_rateio|floatformat:2 }}</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <!-- Tabela de Despesa sem Rateio -->
              <div class="card shadow-sm mb-4">
                <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-user-minus me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                    <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Rela√ß√£o de Despesas sem Rateio</h4>
                  </div>
                </div>
                <div class="card-body p-4">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 w-auto" style="min-width:600px;max-width:800px;">
                      <thead>
                        <tr class="table-success">
                          <th>Data</th>
                          <th>Grupo</th>
                          <th>Descri√ß√£o</th>
                          <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for desp in relatorio.despesas_sem_rateio|dictsort:"data" %}
                        <tr>
                          <td>{{ desp.data }}</td>
                          <td>{{ desp.grupo }}</td>
                          <td>{{ desp.descricao }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ desp.valor_total|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="4" class="text-center text-muted">Nenhuma despesa sem rateio encontrada para o s√≥cio neste per√≠odo.</td>
                        </tr>
                        {% endfor %}
                        <tr style="background-color: #343a40 !important; color: white !important;"><th colspan="3" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Total</th><td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.despesa_sem_rateio|floatformat:2 }}</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm mb-4">
            <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
              <div class="d-flex align-items-center">
                <i class="fas fa-file-invoice-dollar me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Notas Fiscais Recebidas no M√™s</h4>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="table-responsive rounded shadow-sm p-3 bg-light">
                <div class="bg-white rounded-2 p-2">
                  <table class="table table-sm table-bordered table-striped table-hover mb-0" style="width:100%;min-width:1200px;max-width:none;">
                    <thead>
                      <tr class="table-success">
                        <th>Id</th><th>N√∫mero</th><th>Tp aliquota</th><th>Data Emiss√£o</th><th>Data Recebimento</th><th>Tomador</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">% Rateio</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor bruto</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">ISS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">PIS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">COFINS</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">IRPJ</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">CSLL</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Outros</th>
                        <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor l√≠quido</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for nota in relatorio.notas_fiscais %}
                      <tr>
                        <td>{{ nota.id }}</td><td>{{ nota.numero }}</td><td>{{ nota.tp_aliquota }}</td><td>{{ nota.data_emissao }}</td><td>{{ nota.data_recebimento }}</td><td>{{ nota.tomador }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.percentual_rateio|floatformat:2 }}%</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_bruto|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.iss|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.pis|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.cofins|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.irpj|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.csll|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.outros|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_liquido|floatformat:2 }}</td>
                      </tr>
                      {% endfor %}
                      <tr style="background-color: #343a40 !important; color: white !important;">
                        <th colspan="7" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Totais</th>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_valor_bruto|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_iss|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_pis|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_cofins|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_irpj|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_csll|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_outros|floatformat:2 }}</td>
                        <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_valor_liquido|floatformat:2 }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabela: Notas Fiscais Emitidas no M√™s -->
          <div class="card shadow-sm mb-4">
            <div class="card-header px-3 py-2" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; border: none !important;">
              <div class="d-flex align-items-center">
                <i class="fas fa-file-invoice me-2" style="color: #ffffff !important; font-size: 1.1em;"></i>
                <h4 class="mb-0" style="color: #ffffff !important; font-weight: bold !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important; font-size: 1.1rem !important;">Notas Fiscais Emitidas no M√™s</h4>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" style="width:100%;min-width:1200px;max-width:none;">
                  <thead>
                    <tr class="table-success">
                      <th>Id</th><th>N√∫mero</th><th>Tp aliquota</th><th>Data Emiss√£o</th><th>Data Recebimento</th><th>Tomador</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">% Rateio</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor bruto</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">ISS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">PIS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">COFINS</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">IRPJ</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">CSLL</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Outros</th>
                      <th style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Valor l√≠quido</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for nota in relatorio.notas_fiscais_emitidas %}
                    <tr>
                      <td>{{ nota.id }}</td><td>{{ nota.numero }}</td><td>{{ nota.tp_aliquota }}</td><td>{{ nota.data_emissao }}</td><td>{{ nota.data_recebimento }}</td><td>{{ nota.tomador }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.percentual_rateio|floatformat:2 }}%</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_bruto|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.iss|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.pis|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.cofins|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.irpj|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.csll|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.outros|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ nota.valor_liquido|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                    <tr style="background-color: #343a40 !important; color: white !important;">
                      <th colspan="7" style="background-color: #343a40 !important; color: white !important; font-weight: bold !important;">Totais</th>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_valor_bruto|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_iss|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_pis|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_cofins|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_irpj|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_csll|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_outros|floatformat:2 }}</td>
                      <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.total_nf_emitidas_valor_liquido|floatformat:2 }}</td>
                    </tr>
                  </tbody>
                  </table>
              </div>
            </div>
          </div>
          <footer class="text-center text-muted mt-5 mb-2" style="font-size:0.95rem;">Relat√≥rio gerado em {{ relatorio.data_geracao }}</footer>
          
          <!-- Se√ß√£o de Informa√ß√µes Complementares integrada -->
          <div class="row g-3 mt-4">
            <div class="col-md-6">
              <!-- Espelho do Adicional de IR Mensal -->
              <div class="card border-warning shadow-sm h-100">
                <div class="card-header bg-warning bg-opacity-10 border-warning fw-bold">
                  <i class="fas fa-calculator text-warning me-2"></i>
                  ESPELHO DO ADICIONAL DE IR MENSAL
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped table-hover mb-0" style="max-width: 700px; min-width: 600px;">
                      <colgroup>
                        <col style="width: 70%;">
                        <col style="width: 30%; min-width: 120px;">
                      </colgroup>
                      <tr class="table-primary">
                        <td colspan="2" class="text-start">Receita bruta de notas emitidas no m√™s (empresa):</td>
                        <td class="text-end text-nowrap">R$ {{ relatorio.total_notas_bruto|floatformat:2 }}</td>
                      </tr>
                      <tr>
                        <td colspan="2" class="text-start">Base sobre notas emitidas tipo "consultas m√©dicas": ({{ base_consultas_medicas|floatformat:2|default:"0,00" }} √ó 32,00%)</td>
                        <td class="text-end text-nowrap">R$ {{ base_calculo_consultas_ir|floatformat:2|default:"0,00" }}</td>
                      </tr>
                      <tr>
                        <td colspan="2" class="text-start">Base sobre notas emitidas do tipo "outros servi√ßos": ({{ base_outros_servicos|floatformat:2|default:"0,00" }} √ó 8,00%)</td>
                        <td class="text-end text-nowrap">R$ {{ base_calculo_outros_ir|floatformat:2|default:"0,00" }}</td>
                      </tr>
                      <tr class="table-info">
                        <td colspan="2" class="text-start">Base de c√°lculo do IR (total): ({{ base_calculo_consultas_ir|floatformat:2|default:"0,00" }} + {{ base_calculo_outros_ir|floatformat:2|default:"0,00" }})</td>
                        <td class="text-end text-nowrap">R$ {{ relatorio.base_calculo_ir_total|floatformat:2|default:"0,00" }}</td>
                      </tr>
                      <tr class="table-secondary">
                        <td colspan="2" class="text-start">Limite de isen√ß√£o do adicional de IR:</td>
                        <td class="text-end text-nowrap">R$ {{ valor_base_adicional|floatformat:2 }}</td>
                      </tr>
                      <tr class="table-warning">
                        <td colspan="2" class="text-start">Excedente sujeito ao adicional: ({{ relatorio.base_calculo_ir_total|floatformat:2|default:"0,00" }} - {{ valor_base_adicional|floatformat:2 }})</td>
                        <td class="text-end text-nowrap">R$ {{ excedente_adicional|floatformat:2|default:"0,00" }}</td>
                      </tr>
                      <tr class="table-secondary">
                        <td colspan="2" class="text-start">Al√≠quota do adicional de IR:</td>
                        <td class="text-end text-nowrap">{{ aliquota_adicional|floatformat:2 }}%</td>
                      </tr>
                      <tr class="table-success">
                        <td colspan="2" class="text-start">Adicional de IR devido pela empresa: {{ excedente_adicional|floatformat:2|default:"0,00" }} √ó {{ aliquota_adicional|floatformat:2 }}%</td>
                        <td class="text-end text-nowrap">R$ {{ valor_adicional_rateio|floatformat:2|default:"0,00" }}</td>
                      </tr>
                      <tr class="table-primary">
                        <td colspan="2" class="text-start">Receita bruta total de notas emitidas do s√≥cio:</td>
                        <td class="text-end text-nowrap">R$ {{ receita_bruta_socio|floatformat:2 }}</td>
                      </tr>
                      <tr class="table-secondary">
                        <td colspan="2" class="text-start">% do s√≥cio na receita bruta da empresa: ({{ receita_bruta_socio|floatformat:2 }} √∑ {{ relatorio.total_notas_bruto|floatformat:2 }})</td>
                        <td class="text-end text-nowrap">{{ participacao_socio_percentual|floatformat:2 }}%</td>
                      </tr>
                      <tr class="table-danger">
                        <td colspan="2" class="text-start">Valor do adicional para o s√≥cio: R$ {{ valor_adicional_rateio|floatformat:2 }} x ({{ receita_bruta_socio|floatformat:2 }} √∑ {{ relatorio.total_notas_bruto|floatformat:2 }})</td>
                        <td class="text-end text-nowrap">R$ {{ relatorio.total_irpj_adicional|floatformat:2 }}</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <!-- Espelho C√°lculo de Impostos -->
              <div class="card shadow-sm border-success h-100">
                <div class="card-header bg-success bg-opacity-10 border-success fw-bold">
                  <i class="fas fa-calculator text-success me-2"></i>
                  <span>Espelho C√°lculo de Impostos</span>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered table-striped table-hover mb-0" style="min-width:480px;max-width:600px;">
                      <thead class="table-success">
                        <tr>
                          <th style="width: 25%;" class="text-center">Imposto</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Devido</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">Retido</th>
                          <th style="width: 25%; font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">A Pagar</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="table-info">
                          <td class="fw-bold">Base Consultas M√©dicas</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ base_consultas_socio_regime|floatformat:2|default:"0,00" }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                        </tr>
                        <tr class="table-info">
                          <td class="fw-bold">Base Outros Servi√ßos</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ base_outros_socio_regime|floatformat:2|default:"0,00" }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">-</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">PIS ({{ aliquota_pis|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_pis|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">COFINS ({{ aliquota_cofins|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_cofins|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">IRPJ ({{ aliquota_irpj|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_irpj|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">CSLL ({{ aliquota_csll|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_csll|floatformat:2 }}</td>
                        </tr>
                        <tr>
                          <td class="fw-bold">ISSQN ({{ aliquota_iss|floatformat:2 }}%)</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss_devido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss_retido|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important;">{{ relatorio.total_iss|floatformat:2 }}</td>
                        </tr>
                        <tr style="background-color: #343a40 !important; color: white !important;">
                          <td class="fw-bold" style="background-color: #343a40 !important; color: white !important;">TOTAL</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_devido_total|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_retido_total|floatformat:2 }}</td>
                          <td style="font-family: 'Courier New', monospace !important; font-weight: 500 !important; text-align: right !important; background-color: #343a40 !important; color: white !important;">{{ relatorio.impostos_total|floatformat:2 }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="px-3 py-2">
                    <small class="text-muted fst-italic">* C√°lculo imposto: por data de emiss√£o da nota (regime compet√™ncia) / por data de recebimento (regime caixa)</small>
                  </div>
                  
                  <!-- Bot√£o para lan√ßamento autom√°tico dos impostos -->
                  {% if relatorio.impostos_total > 0 %}
                  <div class="px-3 pb-3">
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-1 text-primary">
                          <i class="fas fa-university me-2"></i>Lan√ßamento Autom√°tico na Conta Corrente
                        </h6>
                        <small class="text-muted">Os impostos ser√£o lan√ßados automaticamente no m√™s seguinte durante o c√°lculo</small>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block bl_script %}
<!-- Select2 assets e inicializa√ß√£o -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    $('#id_socio').select2({
      placeholder: "Selecione ou digite para filtrar...",
      allowClear: true,
      width: '100%',
      minimumInputLength: 1
    });
  });
  
  // JavaScript para controle do lan√ßamento autom√°tico
  document.addEventListener('DOMContentLoaded', function() {
    const autoLancarCheckbox = document.getElementById('auto_lancar_impostos');
    const atualizarCheckbox = document.getElementById('atualizar_lancamentos');
    
    // Controlar habilita√ß√£o do checkbox de atualizar
    autoLancarCheckbox.addEventListener('change', function() {
      atualizarCheckbox.disabled = !this.checked;
      if (!this.checked) {
        atualizarCheckbox.checked = false;
      } else {
        atualizarCheckbox.checked = true;
      }
    });
    
    // Submeter formul√°rio ao mudar o checkbox de atualizar
    atualizarCheckbox.addEventListener('change', function() {
      if (autoLancarCheckbox.checked) {
        document.getElementById('form-lancamento-automatico').submit();
      }
    });
  });
</script>
<style>
  .select2-container--default .select2-results__option {
    color: #212529;
    background-color: #fff;
  }
  .select2-container--default .select2-selection__rendered {
    color: #212529;
  }
  /* Evitar quebra de linha na tabela de notas fiscais */
  .table-notas-fiscais td, .table-notas-fiscais th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-notas-fiscais th {
    min-width: 80px;
  }
  .table-notas-fiscais th:nth-child(2),
  .table-notas-fiscais th:nth-child(6),
  .table-notas-fiscais th:nth-child(7) {
    min-width: 120px;
  }
  /* Evitar quebra de linha e barra de rolagem na tabela de despesas com rateio */
  .table-despesas-com-rateio td, .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .table-despesas-com-rateio th {
    white-space: nowrap;
    vertical-align: middle;
  }
  /* Evitar quebra de linha e garantir largura m√≠nima na tabela de movimenta√ß√µes financeiras */
  .table-movimentacoes-financeiras td, .table-movimentacoes-financeiras th {
    white-space: nowrap;
    vertical-align: middle;
    padding-left: 3px;
    padding-right: 3px;
    font-size: 0.95rem;
  }
  .table-movimentacoes-financeiras th {
    min-width: 30px;
  }
  .table-movimentacoes-financeiras th:nth-child(1) { min-width: 28px; max-width:32px; width:32px; }
  .table-movimentacoes-financeiras th:nth-child(2) { min-width: 50px; max-width:60px; width:60px; }
  .table-movimentacoes-financeiras th:nth-child(3) { min-width: 220px; max-width:320px; width:320px; }
  .table-movimentacoes-financeiras th:nth-child(4) { min-width: 50px; max-width:60px; width:60px; }
</style>
{% endblock %}
