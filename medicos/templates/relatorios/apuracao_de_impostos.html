{% extends 'layouts/base_cenario_apuracao.html' %}
{% block content %}
<div class="container-fluid py-4" style="max-width:100vw;">
  <div class="titulo-relatorio">Apuração de Impostos</div>
  <div class="subtitulo-relatorio">Competência: {{ ano }} &nbsp;|&nbsp; Empresa: {{ empresa.nome }}</div>

  <!-- Card Principal - Todas as Apurações -->
  <div class="card shadow border-0">
    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
      <div class="d-flex align-items-center">
        <span class="bi bi-calculator-fill me-3 fs-4"></span>
        <div>
          <h4 class="mb-0 fw-bold">APURAÇÃO CONSOLIDADA DE IMPOSTOS</h4>
          <small class="opacity-75">Análise tributária completa - Lucro Presumido</small>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      
      <!-- Seção PIS -->
      <div class="border-bottom">
        <div class="px-4 py-3 bg-info bg-opacity-10 border-start border-info border-3">
          <h5 class="mb-0 text-info">
            <span class="bi bi-percent me-2"></span>
            Apuração PIS - Janeiro a Dezembro
          </h5>
        </div>
        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0" style="min-width:700px;">
              <thead class="table-info">
                <tr>
                  <th>Descrição</th>
                  {% for competencia in competencias %}
                    <th class="text-center">{{ competencia|slice:":2" }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for linha in linhas_pis %}
                <tr>
                  <td class="fw-medium">{{ linha.descricao }}</td>
                  {% for valor in linha.valores %}
                    <td class="text-end">{{ valor|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Seção COFINS -->
      <div class="border-bottom">
        <div class="px-4 py-3 bg-success bg-opacity-10 border-start border-success border-3">
          <h5 class="mb-0 text-success">
            <span class="bi bi-percent me-2"></span>
            Apuração COFINS - Janeiro a Dezembro
          </h5>
        </div>
        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0" style="min-width:700px;">
              <thead class="table-success">
                <tr>
                  <th>Descrição</th>
                  {% for competencia in competencias %}
                    <th class="text-center">{{ competencia|slice:":2" }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for linha in linhas_cofins %}
                <tr>
                  <td class="fw-medium">{{ linha.descricao }}</td>
                  {% for valor in linha.valores %}
                    <td class="text-end">{{ valor|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Seção ISSQN -->
      <div class="border-bottom">
        <div class="px-4 py-3 bg-warning bg-opacity-10 border-start border-warning border-3">
          <h5 class="mb-0 text-warning">
            <span class="bi bi-building me-2"></span>
            Apuração ISSQN - Janeiro a Dezembro
          </h5>
        </div>
        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0" style="min-width:700px;">
              <thead class="table-warning">
                <tr>
                  <th>Descrição</th>
                  {% for competencia in competencias %}
                    <th class="text-center">{{ competencia|slice:":2" }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for linha in linhas_issqn %}
                <tr>
                  <td class="fw-medium">{{ linha.descricao }}</td>
                  {% for valor in linha.valores %}
                    <td class="text-end">{{ valor|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Seção IRPJ Mensal -->
      <div class="border-bottom">
        <div class="px-4 py-3 bg-danger bg-opacity-10 border-start border-danger border-3">
          <h5 class="mb-0 text-danger">
            <span class="bi bi-calendar3 me-2"></span>
            Apuração IRPJ Mensal
            <small class="text-muted ms-2">Lei 9.430/1996, Art. 2º - Presunção de Lucro</small>
          </h5>
        </div>
        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0" style="min-width:700px;">
              <thead class="table-danger">
                <tr>
                  <th>Descrição</th>
                  {% for competencia in competencias %}
                    <th class="text-center">{{ competencia|slice:":2" }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for linha in linhas_irpj_mensal %}
                <tr>
                  <td class="fw-medium">{{ linha.descricao }}</td>
                  {% for valor in linha.valores %}
                    <td class="text-end">{{ valor|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="px-3 py-2 bg-danger bg-opacity-5 rounded mt-2">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              <strong>Nota:</strong> Cálculo individual baseado nos rateios específicos do sócio. Base de cálculo considera apenas a receita individual, não a receita total da empresa.
            </small>
          </div>
        </div>
      </div>

      <!-- Seção IRPJ e CSLL Trimestral -->
      <div class="border-bottom">
        <div class="px-4 py-3 bg-secondary bg-opacity-10 border-start border-secondary border-3">
          <h5 class="mb-0 text-secondary">
            <span class="bi bi-calendar4-range me-2"></span>
            Apuração Trimestral - IRPJ e CSLL
          </h5>
        </div>
        <div class="p-3">
          <div class="row">
            <!-- IRPJ Trimestral -->
            <div class="col-12 col-xl-6 mb-4">
              <div class="border rounded p-3 h-100 bg-light bg-opacity-50">
                <h6 class="text-secondary mb-3">
                  <span class="bi bi-percent me-1"></span>
                  IRPJ - Trimestres
                </h6>
                <div class="table-responsive">
                  <table class="table table-bordered table-striped table-hover mb-0 table-sm">
                    <thead class="table-secondary">
                      <tr>
                        <th style="width: 60%;">Descrição</th>
                        {% for trimestre in trimestres %}
                          <th class="text-center" style="width: 10%;">{{ trimestre }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for linha in linhas_irpj %}
                      <tr>
                        <td class="small">{{ linha.descricao }}</td>
                        {% for valor in linha.valores %}
                          <td class="text-end small">{{ valor|floatformat:2 }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- CSLL Trimestral -->
            <div class="col-12 col-xl-6 mb-4">
              <div class="border rounded p-3 h-100 bg-light bg-opacity-50">
                <h6 class="text-primary mb-3">
                  <span class="bi bi-percent me-1"></span>
                  CSLL - Trimestres
                </h6>
                <div class="table-responsive">
                  <table class="table table-bordered table-striped table-hover mb-0 table-sm">
                    <thead class="table-primary">
                      <tr>
                        <th style="width: 60%;">Descrição</th>
                        {% for trimestre in trimestres %}
                          <th class="text-center" style="width: 10%;">{{ trimestre }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for linha in linhas_csll %}
                      <tr>
                        <td class="small">{{ linha.descricao }}</td>
                        {% for valor in linha.valores %}
                          <td class="text-end small">{{ valor|floatformat:2 }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção Espelho do Adicional -->
      <div>
        <div class="px-4 py-3 bg-warning bg-opacity-10 border-start border-warning border-3">
          <h5 class="mb-0 text-warning">
            <span class="bi bi-calculator me-2"></span>
            ESPELHO DO ADICIONAL DE IR TRIMESTRAL
          </h5>
        </div>
        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0" style="min-width:900px;">
              <thead class="table-warning">
                <tr>
                  <th style="width: 35%;">Descrição</th>
                  <th class="text-center" style="width: 16.25%;">T1</th>
                  <th class="text-center" style="width: 16.25%;">T2</th>
                  <th class="text-center" style="width: 16.25%;">T3</th>
                  <th class="text-center" style="width: 16.25%;">T4</th>
                </tr>
              </thead>
              <tbody>
                <tr class="table-primary">
                  <td class="text-end fw-medium">Receita bruta total da empresa no trimestre:</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">R$ {{ espelho.receita_bruta|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr>
                  <td class="text-end">Base das notas fiscais recebidas do tipo "consultas médicas": (× 32,00%)</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">{{ espelho.receita_consultas|floatformat:2 }} × 32% = R$ {{ espelho.base_calculo_consultas|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr>
                  <td class="text-end">Base das notas fiscais recebidas do tipo "outros serviços": (× 8,00%)</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">{{ espelho.receita_outros|floatformat:2 }} × 8% = R$ {{ espelho.base_calculo_outros|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr class="table-info">
                  <td class="text-end fw-medium">Base de cálculo do IR (total): (consultas + outros)</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">{{ espelho.base_calculo_consultas|floatformat:2 }} + {{ espelho.base_calculo_outros|floatformat:2 }} = R$ {{ espelho.base_calculo_total|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr class="table-secondary">
                  <td class="text-end">Limite de isenção do adicional de IR:</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">R$ {{ espelho.limite_isencao|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr class="table-warning">
                  <td class="text-end fw-medium">Excedente sujeito ao adicional: (base cálculo - limite)</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">{{ espelho.base_calculo_total|floatformat:2 }} - {{ espelho.limite_isencao|floatformat:2 }} = R$ {{ espelho.excedente|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
                <tr class="table-secondary">
                  <td class="text-end">Alíquota do adicional de IR:</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end">{{ espelho.aliquota_adicional|floatformat:2 }}%</td>
                  {% endfor %}
                </tr>
                <tr class="table-success">
                  <td class="text-end fw-bold">Adicional de IR devido pela empresa: excedente × 10,00%</td>
                  {% for espelho in espelho_adicional_trimestral %}
                    <td class="text-end fw-bold">{{ espelho.excedente|floatformat:2 }} × 10% = R$ {{ espelho.adicional_devido|floatformat:2 }}</td>
                  {% endfor %}
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Seção Espelho do Adicional Mensal -->
      <div class="border-top">
        <div class="px-4 py-3 bg-success bg-opacity-10 border-start border-success border-3">
          <h5 class="mb-0 text-success">
            <span class="bi bi-person-check me-2"></span>
            ESPELHO DO ADICIONAL DE IR MENSAL - JULHO/2025
          </h5>
        </div>
        <div class="p-3">
          {% if espelho_adicional_mensal %}
            {% for espelho in espelho_adicional_mensal %}
            <!-- Card para cada sócio -->
            <div class="card shadow border-0 mb-4">
              <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="d-flex align-items-center">
                  <span class="bi bi-person-badge me-3 fs-4"></span>
                  <div>
                    <h5 class="mb-0 fw-bold">{{ espelho.socio_nome }}</h5>
                    <small class="opacity-75">Cálculo Individual do Adicional de IR - Julho/2025</small>
                  </div>
                </div>
              </div>
              
              <div class="card-body p-4">
                <div class="table-responsive">
                  <table class="table table-borderless mb-0">
                    <tbody>
                      <!-- Receita Individual do Sócio -->
                      <tr class="table-primary">
                        <td colspan="2" class="fw-bold text-primary border-bottom border-2 border-primary pb-2">
                          <i class="bi bi-currency-dollar me-2"></i>
                          RECEITA INDIVIDUAL DO SÓCIO:
                        </td>
                      </tr>
                      <tr>
                        <td class="ps-4" style="width: 60%;">• Consultas</td>
                        <td class="text-end fw-medium">R$ {{ espelho.receita_consultas|floatformat:2 }}</td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Outros serviços</td>
                        <td class="text-end fw-medium">R$ {{ espelho.receita_outros|floatformat:2 }}</td>
                      </tr>
                      <tr class="table-light">
                        <td class="ps-4 fw-bold">• Total</td>
                        <td class="text-end fw-bold text-primary">R$ {{ espelho.receita_total|floatformat:2 }}</td>
                      </tr>
                      
                      <!-- Espaçamento -->
                      <tr><td colspan="2" class="py-2"></td></tr>
                      
                      <!-- Base de Cálculo IR -->
                      <tr class="table-info">
                        <td colspan="2" class="fw-bold text-info border-bottom border-2 border-info pb-2">
                          <i class="bi bi-calculator me-2"></i>
                          BASE DE CÁLCULO IR (INDIVIDUAL):
                        </td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Base consultas (32%)</td>
                        <td class="text-end fw-medium">R$ {{ espelho.base_consultas|floatformat:2 }}</td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Base outros (8%)</td>
                        <td class="text-end fw-medium">R$ {{ espelho.base_outros|floatformat:2 }}</td>
                      </tr>
                      <tr class="table-light">
                        <td class="ps-4 fw-bold">• Base total</td>
                        <td class="text-end fw-bold text-info">R$ {{ espelho.base_total|floatformat:2 }}</td>
                      </tr>
                      
                      <!-- Espaçamento -->
                      <tr><td colspan="2" class="py-2"></td></tr>
                      
                      <!-- Adicional de IR -->
                      <tr class="table-warning">
                        <td colspan="2" class="fw-bold text-warning border-bottom border-2 border-warning pb-2">
                          <i class="bi bi-percent me-2"></i>
                          ADICIONAL DE IR:
                        </td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Valor base para adicional</td>
                        <td class="text-end fw-medium">R$ {{ espelho.limite_adicional|floatformat:2 }}</td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Base individual do sócio</td>
                        <td class="text-end fw-medium">R$ {{ espelho.base_total|floatformat:2 }}</td>
                      </tr>
                      <tr>
                        <td class="ps-4">• Excedente</td>
                        <td class="text-end fw-medium">R$ {{ espelho.excedente|floatformat:2 }}</td>
                      </tr>
                      <tr class="{% if espelho.adicional_devido > 0 %}table-danger{% else %}table-success{% endif %}">
                        <td class="ps-4 fw-bold">• RATEIO IR {% if espelho.adicional_devido > 0 %}DEVIDO{% else %}CORRIGIDO{% endif %}</td>
                        <td class="text-end fw-bold {% if espelho.adicional_devido > 0 %}text-danger{% else %}text-success{% endif %}">
                          R$ {{ espelho.adicional_devido|floatformat:2 }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Detalhamento do Cálculo -->
                <div class="mt-3 p-3 bg-light rounded">
                  <h6 class="fw-bold mb-2">
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    Detalhamento do Cálculo:
                  </h6>
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">
                        <strong>Fórmula Base Consultas:</strong><br>
                        R$ {{ espelho.receita_consultas|floatformat:2 }} × 32% = R$ {{ espelho.base_consultas|floatformat:2 }}
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">
                        <strong>Fórmula Base Outros:</strong><br>
                        R$ {{ espelho.receita_outros|floatformat:2 }} × 8% = R$ {{ espelho.base_outros|floatformat:2 }}
                      </small>
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-6">
                      <small class="text-muted">
                        <strong>Cálculo do Excedente:</strong><br>
                        MAX(R$ {{ espelho.base_total|floatformat:2 }} - R$ {{ espelho.limite_adicional|floatformat:2 }}, 0) = R$ {{ espelho.excedente|floatformat:2 }}
                      </small>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">
                        <strong>Adicional Devido:</strong><br>
                        R$ {{ espelho.excedente|floatformat:2 }} × {{ espelho.aliquota_adicional|floatformat:2 }}% = R$ {{ espelho.adicional_devido|floatformat:2 }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            
            <!-- Resumo Geral -->
            <div class="mt-4 p-4 bg-success bg-opacity-10 border border-success rounded">
              <h6 class="fw-bold mb-3 text-success">
                <i class="bi bi-check-circle me-2"></i>
                Resumo da Metodologia Individual:
              </h6>
              <div class="row">
                <div class="col-md-6">
                  <ul class="mb-0 small text-muted">
                    <li><strong>Cálculo Individual:</strong> Cada sócio tem sua base calculada separadamente</li>
                    <li><strong>Presunções de Lucro:</strong> 32% para consultas, 8% para outros serviços</li>
                    <li><strong>Limite Individual:</strong> R$ 20.000,00 por sócio/mês</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="mb-0 small text-muted">
                    <li><strong>Alíquota Adicional:</strong> 10% sobre o excedente individual</li>
                    <li><strong>Período de Referência:</strong> Julho/2025</li>
                    <li><strong>Base Legal:</strong> Lei 9.249/1995 (Presunção de Lucro)</li>
                  </ul>
                </div>
              </div>
            </div>
          {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nenhum sócio teve receita em julho/2025 ou nenhum sócio atingiu o limite para adicional de IR.
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}
